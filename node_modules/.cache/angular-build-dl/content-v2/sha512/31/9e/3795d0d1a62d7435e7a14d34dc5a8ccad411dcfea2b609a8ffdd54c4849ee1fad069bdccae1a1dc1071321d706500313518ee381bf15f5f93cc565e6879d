!function(){function e(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,n){if("undefined"==typeof Symbol||!(Symbol.iterator in Object(e)))return;var t=[],i=!0,r=!1,c=void 0;try{for(var a,s=e[Symbol.iterator]();!(i=(a=s.next()).done)&&(t.push(a.value),!n||t.length!==n);i=!0);}catch(o){r=!0,c=o}finally{try{i||null==s.return||s.return()}finally{if(r)throw c}}return t}(e,t)||function(e,t){if(!e)return;if("string"==typeof e)return n(e,t);var i=Object.prototype.toString.call(e).slice(8,-1);"Object"===i&&e.constructor&&(i=e.constructor.name);if("Map"===i||"Set"===i)return Array.from(e);if("Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i))return n(e,t)}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function n(e,n){(null==n||n>e.length)&&(n=e.length);for(var t=0,i=new Array(n);t<n;t++)i[t]=e[t];return i}function t(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}function i(e,n){for(var t=0;t<n.length;t++){var i=n[t];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}(window.webpackJsonp=window.webpackJsonp||[]).push([[23],{joOy:function(n,r,c){"use strict";c.r(r),c.d(r,"ProfileFixerModule",function(){return ue});var a=c("SVse"),s=c("u9T3"),o=c("Dxy4"),l=c("BTe0"),u=c("txmD"),b=c("C1VQ"),f=c("XNpK"),d=c("uaks"),p=c("g7MM"),h=c("h4JL"),g=c("kNiW"),m=c("XNiG"),v=c("GyhO"),I=c("LRne"),y=c("cp0P"),x=c("Cfvw"),D=c("EY2u"),O=c("NXyV"),V=c("tFpD"),k=c("kSUX"),W=c("lWmb"),j=c("vkgz"),M=c("eIep"),w=c("lJxs"),N=c("Kqap"),C=c("eNwd"),F=c("j8uH"),G=c("8Y7J"),A=c("Qfjl"),P=c("h0Qx"),L=c("7/R1"),U=c("q9NA"),J=c("iELJ"),$=c("n8oj"),S=c("mx0f"),E=c("U3RD"),X=c("VDRc");function T(e,n){if(1&e&&G.Rb(0,"wm-icon",2),2&e){var t=G.ic(4).$implicit;G.pc("icon",(null==t.actions||null==t.actions.apply?null:t.actions.apply.icon)||"save")}}function K(e,n){if(1&e&&G.Ic(0),2&e){var t=G.ic(4).$implicit;G.Jc((null==t.actions||null==t.actions.apply?null:t.actions.apply.caption)||"Apply fixes")}}function R(e,n){if(1&e){var t=G.Xb();G.Wb(0,"button",14),G.ec("click",function(){G.yc(t);var e=G.ic(2).ngIf;return G.ic(2).applyAllFixes(e)}),G.Gc(1,T,1,1,"wm-icon",15),G.Gc(2,K,1,1,"ng-template",null,16,G.Hc),G.Vb()}if(2&e){var i=n.isMobile,r=G.vc(3),c=G.ic(2).ngIf;G.pc("disabled",!c.done),G.Db(1),G.pc("ngIf",i)("ngIfElse",r)}}function Q(e,n){1&e&&(G.Ub(0),G.Gc(1,R,4,3,"ng-template",13),G.Tb())}function z(e,n){1&e&&(G.Wb(0,"p"),G.Ic(1,"Fetching user data..."),G.Vb())}function q(e,n){1&e&&(G.Wb(0,"p"),G.Ic(1,"No anomalies found"),G.Vb())}function H(e,n){if(1&e){var t=G.Xb();G.Wb(0,"li",21),G.Wb(1,"span"),G.Ic(2,"User "),G.Wb(3,"b"),G.Ic(4),G.Vb(),G.Ic(5," do not have a profile document"),G.Vb(),G.Wb(6,"button",22),G.ec("click",function(){G.yc(t);var e=n.$implicit,i=G.ic(3).ngIf;return G.ic(2).createMissingProfile(e,i)}),G.Ic(7,"Create profile"),G.Vb(),G.Vb()}if(2&e){var i=n.$implicit,r=G.ic(3).ngIf;G.Db(4),G.Jc(i.uid),G.Db(2),G.pc("disabled",!r.done)}}function Y(e,n){if(1&e){var t=G.Xb();G.Wb(0,"li",21),G.Wb(1,"span"),G.Ic(2,"Document "),G.Wb(3,"b"),G.Ic(4),G.Vb(),G.Ic(5," do not have a matching user"),G.Vb(),G.Wb(6,"button",23),G.ec("click",function(){G.yc(t);var e=n.$implicit,i=G.ic(3).ngIf;return G.ic(2).deleteOrphanProfile(e,i)}),G.Ic(7,"Delete profile"),G.Vb(),G.Vb()}if(2&e){var i=n.$implicit,r=G.ic(3).ngIf;G.Db(4),G.Jc(i.id),G.Db(2),G.pc("disabled",!r.done)}}function _(e,n){if(1&e){var t=G.Xb();G.Wb(0,"li",21),G.Wb(1,"span"),G.Ic(2,"Folder "),G.Wb(3,"b"),G.Ic(4),G.Vb(),G.Ic(5," do not have a matching user"),G.Vb(),G.Wb(6,"button",24),G.ec("click",function(){G.yc(t);var e=n.$implicit,i=G.ic(4).ngIf;return G.ic(2).deleteOrphanFolder(e,i)}),G.Ic(7,"Delete folder"),G.Vb(),G.Vb()}if(2&e){var i=n.$implicit;G.Db(4),G.Jc(i.name)}}function B(e,n){if(1&e&&(G.Ub(0),G.Gc(1,_,8,1,"li",18),G.Tb()),2&e){var t=G.ic(3).ngIf;G.Db(1),G.pc("ngForOf",t.folders)}}function Z(e,n){if(1&e){var t=G.Xb();G.Wb(0,"li",21),G.Wb(1,"span"),G.Ic(2),G.Vb(),G.Wb(3,"button",25),G.ec("click",function(){G.yc(t);var e=n.ngIf,i=G.ic(3).ngIf;return G.ic(2).guessMissingUserNames(e,i)}),G.Ic(4,"Guess user names"),G.Vb(),G.Vb()}if(2&e){var i=n.ngIf;G.Db(2),G.Kc("",i.length," user(s) miss a unique user name")}}function ee(e,n){if(1&e){var t=G.Xb();G.Wb(0,"li",21),G.Wb(1,"span"),G.Ic(2),G.Vb(),G.Wb(3,"button",25),G.ec("click",function(){G.yc(t);var e=n.ngIf,i=G.ic(3).ngIf;return G.ic(2).guessMissingFullNames(e,i)}),G.Ic(4,"Guess full names"),G.Vb(),G.Vb()}if(2&e){var i=n.ngIf;G.Db(2),G.Kc("",i.length," user(s) miss the fullName field")}}function ne(e,n){if(1&e){var t=G.Xb();G.Wb(0,"li",21),G.Wb(1,"span"),G.Ic(2),G.Vb(),G.Wb(3,"button",25),G.ec("click",function(){G.yc(t);var e=n.ngIf,i=G.ic(3).ngIf;return G.ic(2).computeMissingSearchIndex(e,i)}),G.Ic(4,"Fix search indexes"),G.Vb(),G.Vb()}if(2&e){var i=n.ngIf;G.Db(2),G.Kc("",i.length," user(s) aren't searchable or the search index mismatches the user's name")}}function te(e,n){if(1&e){var t=G.Xb();G.Ub(0),G.Wb(1,"p"),G.Ic(2),G.Vb(),G.Wb(3,"ul"),G.Gc(4,H,8,2,"li",18),G.Gc(5,Y,8,2,"li",18),G.Gc(6,B,2,1,"ng-container",3),G.Gc(7,Z,5,1,"li",19),G.Gc(8,ee,5,1,"li",19),G.Gc(9,ne,5,1,"li",19),G.Vb(),G.Wb(10,"button",20),G.ec("click",function(){G.yc(t);var e=G.ic(2).ngIf;return G.ic(2).fixAllAnomalies(e)}),G.Wb(11,"span"),G.Ic(12),G.Vb(),G.Vb(),G.Tb()}if(2&e){var i=G.ic(2).ngIf,r=G.ic().$implicit;G.Db(2),G.Kc("",i.errorsCount," anomalies detected:"),G.Db(2),G.pc("ngForOf",i.missing),G.Db(1),G.pc("ngForOf",i.orphans),G.Db(1),G.pc("ngIf",i.done),G.Db(1),G.pc("ngIf",i.userNameMissing),G.Db(1),G.pc("ngIf",i.fullNameMissing),G.Db(1),G.pc("ngIf",i.searchIndexMissing),G.Db(1),G.pc("disabled",!i.done),G.Db(2),G.Jc((null==r.actions||null==r.actions.fix?null:r.actions.fix.caption)||"Fix all anomalies")}}function ie(e,n){if(1&e&&(G.Ub(0),G.Wb(1,"p"),G.Ic(2),G.Vb(),G.Gc(3,q,2,0,"ng-template",null,17,G.Hc),G.Gc(5,te,13,9,"ng-container",12),G.Tb()),2&e){var t=G.vc(4),i=G.ic().ngIf;G.Db(2),G.Kc("Analysing uid ",i.currentId,""),G.Db(3),G.pc("ngIf",i.errorsCount>0)("ngIfElse",t)}}function re(e,n){if(1&e&&(G.Wb(0,"section"),G.Gc(1,Q,2,0,"ng-container",3),G.Rb(2,"mat-progress-bar",10),G.Gc(3,z,2,0,"ng-template",null,11,G.Hc),G.Gc(5,ie,6,3,"ng-container",12),G.Vb()),2&e){var t=n.ngIf,i=G.vc(4),r=G.ic(2);G.Db(1),G.pc("ngIf",r.batch||(null==t.folders?null:t.folders.length)),G.Db(1),G.pc("mode",t.users?"determinate":"query")("value",100*((t.currentIndex||0)+1)/((null==t.users?null:t.users.length)||1)),G.Db(3),G.pc("ngIf",t.users)("ngIfElse",i)}}function ce(e,n){if(1&e){var t=G.Xb();G.Ub(0),G.Wb(1,"button",1),G.ec("click",function(){return G.yc(t),G.ic().run$.next()}),G.Rb(2,"wm-icon",2),G.Wb(3,"span"),G.Ic(4),G.Vb(),G.Vb(),G.Gc(5,re,6,5,"section",3),G.jc(6,"async"),G.Wb(7,"wm-dialog",4),G.Wb(8,"h2",5),G.Wb(9,"b"),G.Ic(10),G.Vb(),G.Vb(),G.Wb(11,"mat-dialog-content",6),G.Wb(12,"span"),G.Ic(13,"You're about to leave the page without saving the applied fixes."),G.Rb(14,"br"),G.Ic(15,"Please confirm."),G.Vb(),G.Vb(),G.Wb(16,"mat-dialog-actions",7),G.Wb(17,"button",8),G.Ic(18),G.Vb(),G.Wb(19,"button",9),G.Ic(20),G.Vb(),G.Vb(),G.Vb(),G.Tb()}if(2&e){var i=n.$implicit,r=G.ic();G.Db(2),G.pc("icon",(null==i.actions||null==i.actions.run?null:i.actions.run.icon)||"assignment"),G.Db(2),G.Jc((null==i.actions||null==i.actions.run?null:i.actions.run.caption)||"Analyze users"),G.Db(1),G.pc("ngIf",G.kc(6,10,r.report$)),G.Db(2),G.pc("dontLeave",r.batch),G.Db(3),G.Jc((null==i.canLeave?null:i.canLeave.title)||"Unsaved fixes"),G.Db(1),G.pc("wm-readme",null==i.canLeave?null:i.canLeave.message),G.Db(6),G.pc("mat-dialog-close",!1),G.Db(1),G.Jc((null==i.canLeave?null:i.canLeave.cancel)||"Stay"),G.Db(1),G.pc("mat-dialog-close",!0),G.Db(1),G.Jc((null==i.canLeave?null:i.canLeave.ok)||"Leave anyhow")}}var ae,se=((ae=function(){function n(i,r,c){var a=this;t(this,n),this.client=i,this.users=r,this.st=c,this.run$=new m.a,this.report$=this.run$.pipe(Object(j.a)(function(){a.batch=null}),Object(M.a)(function(){return Object(v.a)(Object(I.a)({}),Object(y.a)(a.listAllUsers(),a.listAllProfiles(),a.listAllFolders()).pipe(Object(w.a)(function(n){var t=e(n,3);return{users:t[0],profiles:t[1],folders:t[2],missing:[],orphans:[],currentId:"",errorsCount:0}}),Object(M.a)(function(e){return Object(x.a)(e.users,C.a).pipe(Object(N.a)(function(e,n,t){e.currentId=n.uid,e.currentIndex=t;var i=e.profiles[t-e.missing.length+e.orphans.length];!i||i.id>n.uid?(e.missing.push(n),e.errorsCount++):i.id<n.uid&&(e.orphans.push(i),e.errorsCount++);var r=e.folders.findIndex(function(e){return e.name===n.uid});return r>=0&&e.folders.splice(r,1),a.analyzeProfile(i,e),e},e),Object(F.a)(function(e){var n=e.users.length-e.missing.length+e.orphans.length;return n>=e.profiles.length?Object(D.b)():Object(x.a)(e.profiles.slice(n),C.a).pipe(Object(N.a)(function(e,n){return e.currentId=n.id,e.currentIndex++,e.orphans.push(n),e.errorsCount++,e},e))},e),Object(F.a)(function(e){return Object(I.a)(Object.assign(Object.assign({},e),{done:!0}))}))})))}))}var r,c,a;return r=n,(c=[{key:"db",get:function(){return this.users.db}},{key:"listAllUsers",value:function(){return this.client.get("users")}},{key:"listAllProfiles",value:function(){var e=this;return Object(O.a)(function(){return e.users.get(function(n){return n.orderBy(e.db.sentinelId)})})}},{key:"deleteFolder",value:function(e){return this.client.delete("folders/".concat(e))}},{key:"listAllFolders",value:function(){return this.st.reference("/").listAll().pipe(Object(w.a)(function(e){return e.prefixes}))}},{key:"analyzeProfile",value:function(e,n){if(!e)return n;if(e.userName||(n.userNameMissing=(n.userNameMissing||[]).concat(e),n.errorsCount++),e.fullName||(n.fullNameMissing=(n.fullNameMissing||[]).concat(e),n.errorsCount++),e.searchIndex){var t=this.users.formatData(Object.assign({lastName:""},e)).searchIndex;(t.length!==e.searchIndex.length||t.some(function(n,t){return n!==e.searchIndex[t]}))&&(n.searchIndexMissing=(n.searchIndexMissing||[]).concat(e),n.errorsCount++)}else n.searchIndexMissing=(n.searchIndexMissing||[]).concat(e),n.errorsCount++;return n}},{key:"createMissingProfile",value:function(e,n){var t=n.missing.findIndex(function(n){return n===e});t>=0&&((this.batch||(this.batch=this.db.batch())).set(this.users.ref.doc(e.uid),this.users.userData(e)),n.missing.splice(t,1),n.errorsCount--)}},{key:"deleteOrphanProfile",value:function(e,n){var t=n.orphans.findIndex(function(n){return n===e});t>=0&&((this.batch||(this.batch=this.db.batch())).delete(this.users.ref.doc(e.id)),n.orphans.splice(t,1),n.errorsCount--)}},{key:"deleteOrphanFolder",value:function(e,n){var t=n.folders.findIndex(function(n){return n===e});t>=0&&this.deleteFolder(e.name).subscribe(function(){n.folders.splice(t,1),n.errorsCount--})}},{key:"guessMissingUserNames",value:function(e,n){var t=this;if(e){var i=this.batch||(this.batch=this.db.batch()),r=[];Promise.all(e.map(function(e){var c=t.users.formatData(Object.assign({lastName:""},e)).fullName;return t.users.guessUserName(c).then(function(c){for(;r.find(function(e){return e===c});)c=c.concat("z");console.log("Guessing",c),i.update(t.users.ref.doc(e.id),{userName:c}),r.push(c),n.errorsCount--})})).then(function(){return delete n.userNameMissing})}}},{key:"guessMissingFullNames",value:function(e,n){var t=this;if(e){var i=this.batch||(this.batch=this.db.batch());e.forEach(function(e){var r=t.users.formatData(Object.assign({lastName:""},e)).fullName;i.update(t.users.ref.doc(e.id),{fullName:r}),n.errorsCount--}),delete n.userNameMissing}}},{key:"computeMissingSearchIndex",value:function(e,n){var t=this;if(e){var i=this.batch||(this.batch=this.db.batch());e.forEach(function(e){var r=t.users.formatData(Object.assign({lastName:""},e)).searchIndex;i.update(t.users.ref.doc(e.id),{searchIndex:r}),n.errorsCount--}),delete n.searchIndexMissing}}},{key:"fixAllAnomalies",value:function(e){var n,t,i=this;null===(n=e.missing)||void 0===n||n.forEach(function(n){return i.createMissingProfile(n,e)}),null===(t=e.orphans)||void 0===t||t.forEach(function(n){return i.deleteOrphanProfile(n,e)}),this.guessMissingUserNames(e.userNameMissing,e),this.computeMissingSearchIndex(e.searchIndexMissing,e)}},{key:"applyAllFixes",value:function(e){var n=this;e&&Object(y.a)(Object(x.a)(this.batch?this.batch.commit():Object(D.b)()),Object(x.a)(e.folders||[]).pipe(Object(M.a)(function(e){return n.deleteFolder(e.name)}))).toPromise().then(function(){return n.batch=null})}}])&&i(r.prototype,c),a&&i(r,a),n}()).\u0275fac=function(e){return new(e||ae)(G.Qb(k.b),G.Qb(W.b),G.Qb(V.b))},ae.\u0275cmp=G.Kb({type:ae,selectors:[["wm-profile-fixer"]],decls:1,vars:1,consts:[[4,"wmContent","wmContentSelect"],["mat-stroked-button","","color","primary",3,"click"],[3,"icon"],[4,"ngIf"],[3,"dontLeave"],["mat-dialog-title",""],[3,"wm-readme"],["align","end"],["mat-button","","color","primary","cdkFocusInitial","",3,"mat-dialog-close"],["mat-button","","color","warn",3,"mat-dialog-close"],["color","primary",3,"mode","value"],["fetchingUsers",""],[4,"ngIf","ngIfElse"],["wmActionbar",""],["mat-flat-button","","type.lt-sm","icon","color","primary",3,"disabled","click"],[3,"icon",4,"ngIf","ngIfElse"],["applyFixes",""],["allFine",""],["fxLayoutGap","8px",4,"ngFor","ngForOf"],["fxLayoutGap","8px",4,"ngIf"],["mat-stroked-button","","color","warn",3,"disabled","click"],["fxLayoutGap","8px"],["mat-button","","color","accent",3,"disabled","click"],["mat-button","","color","warn",3,"disabled","click"],["mat-button","","color","warn",3,"click"],["mat-button","","color","accent",3,"click"]],template:function(e,n){1&e&&G.Gc(0,ce,21,12,"ng-container",0),2&e&&G.pc("wmContentSelect","admin-fixer")},directives:[A.a,o.b,P.a,a.m,L.a,U.a,J.h,J.e,$.a,J.c,J.d,l.a,S.a,E.a,a.l,X.f],pipes:[a.b],styles:["[_nghost-%COMP%]{position:relative;min-height:100%;padding-top:32px;display:flex;flex-direction:column}[_nghost-%COMP%]   .mat-progress-bar[_ngcontent-%COMP%]{margin-bottom:16px}"]}),ae);c("J3Me");var oe,le=[{path:"",content:"admin-fixer",component:se,canDeactivate:[h.a]}],ue=((oe=function e(){t(this,e)}).\u0275mod=G.Ob({type:oe}),oe.\u0275inj=G.Nb({factory:function(e){return new(e||oe)},imports:[[a.c,s.a,o.c,l.b,u.a,b.a,f.b,d.a,g.a,h.b,p.e.forChild(le)]]}),oe)}}])}();