(window.webpackJsonp=window.webpackJsonp||[]).push([[23],{joOy:function(e,n,t){"use strict";t.r(n),t.d(n,"ProfileFixerModule",function(){return ie});var s=t("SVse"),c=t("u9T3"),i=t("Dxy4"),o=t("BTe0"),a=t("txmD"),r=t("C1VQ"),l=t("XNpK"),b=t("uaks"),u=t("g7MM"),f=t("h4JL"),d=t("kNiW"),p=t("XNiG"),h=t("GyhO"),g=t("LRne"),m=t("cp0P"),I=t("Cfvw"),x=t("EY2u"),D=t("NXyV"),V=t("tFpD"),y=t("kSUX"),O=t("lWmb"),W=t("vkgz"),M=t("eIep"),j=t("lJxs"),N=t("Kqap"),v=t("eNwd"),w=t("j8uH"),k=t("8Y7J"),C=t("Qfjl"),F=t("h0Qx"),G=t("7/R1"),A=t("q9NA"),P=t("iELJ"),L=t("n8oj"),J=t("mx0f"),U=t("U3RD"),$=t("VDRc");function X(e,n){if(1&e&&k.Rb(0,"wm-icon",2),2&e){const e=k.ic(4).$implicit;k.pc("icon",(null==e.actions||null==e.actions.apply?null:e.actions.apply.icon)||"save")}}function E(e,n){if(1&e&&k.Ic(0),2&e){const e=k.ic(4).$implicit;k.Jc((null==e.actions||null==e.actions.apply?null:e.actions.apply.caption)||"Apply fixes")}}function K(e,n){if(1&e){const e=k.Xb();k.Wb(0,"button",14),k.ec("click",function(){k.yc(e);const n=k.ic(2).ngIf;return k.ic(2).applyAllFixes(n)}),k.Gc(1,X,1,1,"wm-icon",15),k.Gc(2,E,1,1,"ng-template",null,16,k.Hc),k.Vb()}if(2&e){const e=n.isMobile,t=k.vc(3),s=k.ic(2).ngIf;k.pc("disabled",!s.done),k.Db(1),k.pc("ngIf",e)("ngIfElse",t)}}function R(e,n){1&e&&(k.Ub(0),k.Gc(1,K,4,3,"ng-template",13),k.Tb())}function S(e,n){1&e&&(k.Wb(0,"p"),k.Ic(1,"Fetching user data..."),k.Vb())}function T(e,n){1&e&&(k.Wb(0,"p"),k.Ic(1,"No anomalies found"),k.Vb())}function Q(e,n){if(1&e){const e=k.Xb();k.Wb(0,"li",21),k.Wb(1,"span"),k.Ic(2,"User "),k.Wb(3,"b"),k.Ic(4),k.Vb(),k.Ic(5," do not have a profile document"),k.Vb(),k.Wb(6,"button",22),k.ec("click",function(){k.yc(e);const t=n.$implicit,s=k.ic(3).ngIf;return k.ic(2).createMissingProfile(t,s)}),k.Ic(7,"Create profile"),k.Vb(),k.Vb()}if(2&e){const e=n.$implicit,t=k.ic(3).ngIf;k.Db(4),k.Jc(e.uid),k.Db(2),k.pc("disabled",!t.done)}}function z(e,n){if(1&e){const e=k.Xb();k.Wb(0,"li",21),k.Wb(1,"span"),k.Ic(2,"Document "),k.Wb(3,"b"),k.Ic(4),k.Vb(),k.Ic(5," do not have a matching user"),k.Vb(),k.Wb(6,"button",23),k.ec("click",function(){k.yc(e);const t=n.$implicit,s=k.ic(3).ngIf;return k.ic(2).deleteOrphanProfile(t,s)}),k.Ic(7,"Delete profile"),k.Vb(),k.Vb()}if(2&e){const e=n.$implicit,t=k.ic(3).ngIf;k.Db(4),k.Jc(e.id),k.Db(2),k.pc("disabled",!t.done)}}function q(e,n){if(1&e){const e=k.Xb();k.Wb(0,"li",21),k.Wb(1,"span"),k.Ic(2,"Folder "),k.Wb(3,"b"),k.Ic(4),k.Vb(),k.Ic(5," do not have a matching user"),k.Vb(),k.Wb(6,"button",24),k.ec("click",function(){k.yc(e);const t=n.$implicit,s=k.ic(4).ngIf;return k.ic(2).deleteOrphanFolder(t,s)}),k.Ic(7,"Delete folder"),k.Vb(),k.Vb()}if(2&e){const e=n.$implicit;k.Db(4),k.Jc(e.name)}}function H(e,n){if(1&e&&(k.Ub(0),k.Gc(1,q,8,1,"li",18),k.Tb()),2&e){const e=k.ic(3).ngIf;k.Db(1),k.pc("ngForOf",e.folders)}}function Y(e,n){if(1&e){const e=k.Xb();k.Wb(0,"li",21),k.Wb(1,"span"),k.Ic(2),k.Vb(),k.Wb(3,"button",25),k.ec("click",function(){k.yc(e);const t=n.ngIf,s=k.ic(3).ngIf;return k.ic(2).guessMissingUserNames(t,s)}),k.Ic(4,"Guess user names"),k.Vb(),k.Vb()}if(2&e){const e=n.ngIf;k.Db(2),k.Kc("",e.length," user(s) miss a unique user name")}}function _(e,n){if(1&e){const e=k.Xb();k.Wb(0,"li",21),k.Wb(1,"span"),k.Ic(2),k.Vb(),k.Wb(3,"button",25),k.ec("click",function(){k.yc(e);const t=n.ngIf,s=k.ic(3).ngIf;return k.ic(2).guessMissingFullNames(t,s)}),k.Ic(4,"Guess full names"),k.Vb(),k.Vb()}if(2&e){const e=n.ngIf;k.Db(2),k.Kc("",e.length," user(s) miss the fullName field")}}function B(e,n){if(1&e){const e=k.Xb();k.Wb(0,"li",21),k.Wb(1,"span"),k.Ic(2),k.Vb(),k.Wb(3,"button",25),k.ec("click",function(){k.yc(e);const t=n.ngIf,s=k.ic(3).ngIf;return k.ic(2).computeMissingSearchIndex(t,s)}),k.Ic(4,"Fix search indexes"),k.Vb(),k.Vb()}if(2&e){const e=n.ngIf;k.Db(2),k.Kc("",e.length," user(s) aren't searchable or the search index mismatches the user's name")}}function Z(e,n){if(1&e){const e=k.Xb();k.Ub(0),k.Wb(1,"p"),k.Ic(2),k.Vb(),k.Wb(3,"ul"),k.Gc(4,Q,8,2,"li",18),k.Gc(5,z,8,2,"li",18),k.Gc(6,H,2,1,"ng-container",3),k.Gc(7,Y,5,1,"li",19),k.Gc(8,_,5,1,"li",19),k.Gc(9,B,5,1,"li",19),k.Vb(),k.Wb(10,"button",20),k.ec("click",function(){k.yc(e);const n=k.ic(2).ngIf;return k.ic(2).fixAllAnomalies(n)}),k.Wb(11,"span"),k.Ic(12),k.Vb(),k.Vb(),k.Tb()}if(2&e){const e=k.ic(2).ngIf,n=k.ic().$implicit;k.Db(2),k.Kc("",e.errorsCount," anomalies detected:"),k.Db(2),k.pc("ngForOf",e.missing),k.Db(1),k.pc("ngForOf",e.orphans),k.Db(1),k.pc("ngIf",e.done),k.Db(1),k.pc("ngIf",e.userNameMissing),k.Db(1),k.pc("ngIf",e.fullNameMissing),k.Db(1),k.pc("ngIf",e.searchIndexMissing),k.Db(1),k.pc("disabled",!e.done),k.Db(2),k.Jc((null==n.actions||null==n.actions.fix?null:n.actions.fix.caption)||"Fix all anomalies")}}function ee(e,n){if(1&e&&(k.Ub(0),k.Wb(1,"p"),k.Ic(2),k.Vb(),k.Gc(3,T,2,0,"ng-template",null,17,k.Hc),k.Gc(5,Z,13,9,"ng-container",12),k.Tb()),2&e){const e=k.vc(4),n=k.ic().ngIf;k.Db(2),k.Kc("Analysing uid ",n.currentId,""),k.Db(3),k.pc("ngIf",n.errorsCount>0)("ngIfElse",e)}}function ne(e,n){if(1&e&&(k.Wb(0,"section"),k.Gc(1,R,2,0,"ng-container",3),k.Rb(2,"mat-progress-bar",10),k.Gc(3,S,2,0,"ng-template",null,11,k.Hc),k.Gc(5,ee,6,3,"ng-container",12),k.Vb()),2&e){const e=n.ngIf,t=k.vc(4),s=k.ic(2);k.Db(1),k.pc("ngIf",s.batch||(null==e.folders?null:e.folders.length)),k.Db(1),k.pc("mode",e.users?"determinate":"query")("value",100*((e.currentIndex||0)+1)/((null==e.users?null:e.users.length)||1)),k.Db(3),k.pc("ngIf",e.users)("ngIfElse",t)}}function te(e,n){if(1&e){const e=k.Xb();k.Ub(0),k.Wb(1,"button",1),k.ec("click",function(){return k.yc(e),k.ic().run$.next()}),k.Rb(2,"wm-icon",2),k.Wb(3,"span"),k.Ic(4),k.Vb(),k.Vb(),k.Gc(5,ne,6,5,"section",3),k.jc(6,"async"),k.Wb(7,"wm-dialog",4),k.Wb(8,"h2",5),k.Wb(9,"b"),k.Ic(10),k.Vb(),k.Vb(),k.Wb(11,"mat-dialog-content",6),k.Wb(12,"span"),k.Ic(13,"You're about to leave the page without saving the applied fixes."),k.Rb(14,"br"),k.Ic(15,"Please confirm."),k.Vb(),k.Vb(),k.Wb(16,"mat-dialog-actions",7),k.Wb(17,"button",8),k.Ic(18),k.Vb(),k.Wb(19,"button",9),k.Ic(20),k.Vb(),k.Vb(),k.Vb(),k.Tb()}if(2&e){const e=n.$implicit,t=k.ic();k.Db(2),k.pc("icon",(null==e.actions||null==e.actions.run?null:e.actions.run.icon)||"assignment"),k.Db(2),k.Jc((null==e.actions||null==e.actions.run?null:e.actions.run.caption)||"Analyze users"),k.Db(1),k.pc("ngIf",k.kc(6,10,t.report$)),k.Db(2),k.pc("dontLeave",t.batch),k.Db(3),k.Jc((null==e.canLeave?null:e.canLeave.title)||"Unsaved fixes"),k.Db(1),k.pc("wm-readme",null==e.canLeave?null:e.canLeave.message),k.Db(6),k.pc("mat-dialog-close",!1),k.Db(1),k.Jc((null==e.canLeave?null:e.canLeave.cancel)||"Stay"),k.Db(1),k.pc("mat-dialog-close",!0),k.Db(1),k.Jc((null==e.canLeave?null:e.canLeave.ok)||"Leave anyhow")}}let se=(()=>{class e{constructor(e,n,t){this.client=e,this.users=n,this.st=t,this.run$=new p.a,this.report$=this.run$.pipe(Object(W.a)(()=>{this.batch=null}),Object(M.a)(()=>Object(h.a)(Object(g.a)({}),Object(m.a)(this.listAllUsers(),this.listAllProfiles(),this.listAllFolders()).pipe(Object(j.a)(([e,n,t])=>({users:e,profiles:n,folders:t,missing:[],orphans:[],currentId:"",errorsCount:0})),Object(M.a)(e=>Object(I.a)(e.users,v.a).pipe(Object(N.a)((e,n,t)=>{e.currentId=n.uid,e.currentIndex=t;const s=e.profiles[t-e.missing.length+e.orphans.length];!s||s.id>n.uid?(e.missing.push(n),e.errorsCount++):s.id<n.uid&&(e.orphans.push(s),e.errorsCount++);const c=e.folders.findIndex(e=>e.name===n.uid);return c>=0&&e.folders.splice(c,1),this.analyzeProfile(s,e),e},e),Object(w.a)(e=>{const n=e.users.length-e.missing.length+e.orphans.length;return n>=e.profiles.length?Object(x.b)():Object(I.a)(e.profiles.slice(n),v.a).pipe(Object(N.a)((e,n)=>(e.currentId=n.id,e.currentIndex++,e.orphans.push(n),e.errorsCount++,e),e))},e),Object(w.a)(e=>Object(g.a)(Object.assign(Object.assign({},e),{done:!0})))))))))}get db(){return this.users.db}listAllUsers(){return this.client.get("users")}listAllProfiles(){return Object(D.a)(()=>this.users.get(e=>e.orderBy(this.db.sentinelId)))}deleteFolder(e){return this.client.delete(`folders/${e}`)}listAllFolders(){return this.st.reference("/").listAll().pipe(Object(j.a)(e=>e.prefixes))}analyzeProfile(e,n){if(!e)return n;if(e.userName||(n.userNameMissing=(n.userNameMissing||[]).concat(e),n.errorsCount++),e.fullName||(n.fullNameMissing=(n.fullNameMissing||[]).concat(e),n.errorsCount++),e.searchIndex){const{searchIndex:t}=this.users.formatData(Object.assign({lastName:""},e));(t.length!==e.searchIndex.length||t.some((n,t)=>n!==e.searchIndex[t]))&&(n.searchIndexMissing=(n.searchIndexMissing||[]).concat(e),n.errorsCount++)}else n.searchIndexMissing=(n.searchIndexMissing||[]).concat(e),n.errorsCount++;return n}createMissingProfile(e,n){const t=n.missing.findIndex(n=>n===e);t>=0&&((this.batch||(this.batch=this.db.batch())).set(this.users.ref.doc(e.uid),this.users.userData(e)),n.missing.splice(t,1),n.errorsCount--)}deleteOrphanProfile(e,n){const t=n.orphans.findIndex(n=>n===e);t>=0&&((this.batch||(this.batch=this.db.batch())).delete(this.users.ref.doc(e.id)),n.orphans.splice(t,1),n.errorsCount--)}deleteOrphanFolder(e,n){const t=n.folders.findIndex(n=>n===e);t>=0&&this.deleteFolder(e.name).subscribe(()=>{n.folders.splice(t,1),n.errorsCount--})}guessMissingUserNames(e,n){if(!e)return;const t=this.batch||(this.batch=this.db.batch()),s=[];Promise.all(e.map(e=>{const{fullName:c}=this.users.formatData(Object.assign({lastName:""},e));return this.users.guessUserName(c).then(c=>{for(;s.find(e=>e===c);)c=c.concat("z");console.log("Guessing",c),t.update(this.users.ref.doc(e.id),{userName:c}),s.push(c),n.errorsCount--})})).then(()=>delete n.userNameMissing)}guessMissingFullNames(e,n){if(!e)return;const t=this.batch||(this.batch=this.db.batch());e.forEach(e=>{const{fullName:s}=this.users.formatData(Object.assign({lastName:""},e));t.update(this.users.ref.doc(e.id),{fullName:s}),n.errorsCount--}),delete n.userNameMissing}computeMissingSearchIndex(e,n){if(!e)return;const t=this.batch||(this.batch=this.db.batch());e.forEach(e=>{const{searchIndex:s}=this.users.formatData(Object.assign({lastName:""},e));t.update(this.users.ref.doc(e.id),{searchIndex:s}),n.errorsCount--}),delete n.searchIndexMissing}fixAllAnomalies(e){var n,t;null===(n=e.missing)||void 0===n||n.forEach(n=>this.createMissingProfile(n,e)),null===(t=e.orphans)||void 0===t||t.forEach(n=>this.deleteOrphanProfile(n,e)),this.guessMissingUserNames(e.userNameMissing,e),this.computeMissingSearchIndex(e.searchIndexMissing,e)}applyAllFixes(e){e&&Object(m.a)(Object(I.a)(this.batch?this.batch.commit():Object(x.b)()),Object(I.a)(e.folders||[]).pipe(Object(M.a)(e=>this.deleteFolder(e.name)))).toPromise().then(()=>this.batch=null)}}return e.\u0275fac=function(n){return new(n||e)(k.Qb(y.b),k.Qb(O.b),k.Qb(V.b))},e.\u0275cmp=k.Kb({type:e,selectors:[["wm-profile-fixer"]],decls:1,vars:1,consts:[[4,"wmContent","wmContentSelect"],["mat-stroked-button","","color","primary",3,"click"],[3,"icon"],[4,"ngIf"],[3,"dontLeave"],["mat-dialog-title",""],[3,"wm-readme"],["align","end"],["mat-button","","color","primary","cdkFocusInitial","",3,"mat-dialog-close"],["mat-button","","color","warn",3,"mat-dialog-close"],["color","primary",3,"mode","value"],["fetchingUsers",""],[4,"ngIf","ngIfElse"],["wmActionbar",""],["mat-flat-button","","type.lt-sm","icon","color","primary",3,"disabled","click"],[3,"icon",4,"ngIf","ngIfElse"],["applyFixes",""],["allFine",""],["fxLayoutGap","8px",4,"ngFor","ngForOf"],["fxLayoutGap","8px",4,"ngIf"],["mat-stroked-button","","color","warn",3,"disabled","click"],["fxLayoutGap","8px"],["mat-button","","color","accent",3,"disabled","click"],["mat-button","","color","warn",3,"disabled","click"],["mat-button","","color","warn",3,"click"],["mat-button","","color","accent",3,"click"]],template:function(e,n){1&e&&k.Gc(0,te,21,12,"ng-container",0),2&e&&k.pc("wmContentSelect","admin-fixer")},directives:[C.a,i.b,F.a,s.m,G.a,A.a,P.h,P.e,L.a,P.c,P.d,o.a,J.a,U.a,s.l,$.f],pipes:[s.b],styles:["[_nghost-%COMP%]{position:relative;min-height:100%;padding-top:32px;display:flex;flex-direction:column}[_nghost-%COMP%]   .mat-progress-bar[_ngcontent-%COMP%]{margin-bottom:16px}"]}),e})();t("J3Me");const ce=[{path:"",content:"admin-fixer",component:se,canDeactivate:[f.a]}];let ie=(()=>{class e{}return e.\u0275mod=k.Ob({type:e}),e.\u0275inj=k.Nb({factory:function(n){return new(n||e)},imports:[[s.c,c.a,i.c,o.b,a.a,r.a,l.b,b.a,d.a,f.b,u.e.forChild(ce)]]}),e})()}}]);